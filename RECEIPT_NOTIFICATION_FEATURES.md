# 收据管理和通知系统功能说明

## 新增功能概述

本次更新为PACMC Money系统添加了两个重要功能：

1. **收据管理系统** - 允许用户上传、管理和查看与财务记录相关的收据
2. **通知提醒系统** - 提供实时通知功能，包括收据上传、审批请求等提醒

## 收据管理功能

### 功能特点
- **文件上传**: 支持图片（PNG, JPG等）和PDF文件上传
- **文件大小限制**: 最大10MB
- **标签系统**: 可以为收据添加自定义标签
- **描述功能**: 为收据添加详细描述
- **权限控制**: 只有上传者和管理员可以查看/删除收据
- **实时预览**: 支持在线查看和下载收据

### 使用方法
1. 在编辑财务记录页面，找到"Receipt Management"部分
2. 点击上传区域选择文件
3. 填写可选的描述和标签
4. 点击"Upload"完成上传
5. 上传后可以查看、下载或删除收据

### 技术实现
- 使用Firebase Storage存储文件
- 使用Firestore存储收据元数据
- 实现文件访问权限控制
- 支持实时文件管理

## 通知提醒系统

### 功能特点
- **实时通知**: 基于Firestore实时监听
- **多种通知类型**: 
  - 收据上传成功通知
  - 预算超支警告
  - 账单到期提醒
  - 审批请求通知
  - 系统更新通知
- **通知状态管理**: 支持标记已读/未读
- **通知设置**: 用户可以自定义通知偏好
- **通知铃铛**: 在主页面显示未读通知数量

### 通知类型说明

#### 1. 收据上传通知
- 触发条件: 用户成功上传收据
- 通知内容: 显示上传的文件名和记录链接
- 类型: 成功通知

#### 2. 预算警告通知
- 触发条件: 支出接近或超过预算限制
- 通知内容: 显示预算使用百分比
- 类型: 警告/错误通知

#### 3. 账单提醒通知
- 触发条件: 账单即将到期或已逾期
- 通知内容: 显示账单名称、金额和到期天数
- 类型: 信息/警告/错误通知

#### 4. 审批请求通知
- 触发条件: 新的财务记录需要审批
- 通知内容: 显示记录详情和审批链接
- 类型: 信息通知

### 使用方法

#### 查看通知
1. 点击主页右上角的通知铃铛图标
2. 查看未读通知数量（红色徽章显示）
3. 点击通知可以标记为已读
4. 点击"View Details"可以跳转到相关页面

#### 管理通知设置
1. 访问 `/notifications` 页面
2. 切换到"Settings"标签
3. 配置各种通知类型的开关
4. 设置邮件和推送通知偏好

### 技术实现
- 使用Firestore实时监听通知变化
- 实现通知的CRUD操作
- 支持通知状态管理
- 集成到现有权限系统

## 安全规则

### Firestore规则
- 用户只能访问自己的通知
- 收据访问需要权限验证
- 管理员可以访问所有收据
- 通知设置只能由用户自己管理

### Storage规则
- 文件大小限制10MB
- 只允许图片和PDF文件
- 用户只能上传到自己的记录
- 管理员可以访问所有文件

## 部署说明

### 1. 更新Firebase配置
确保在Firebase控制台中启用了以下服务：
- Firestore Database
- Storage
- Authentication

### 2. 部署安全规则
```bash
# 部署Firestore规则
firebase deploy --only firestore:rules

# 部署Storage规则
firebase deploy --only storage
```

### 3. 环境变量
确保以下环境变量已正确配置：
- `NEXT_PUBLIC_FIREBASE_API_KEY`
- `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`
- `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
- `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`

## 使用建议

### 收据管理最佳实践
1. **文件命名**: 使用有意义的文件名，包含日期和类型
2. **标签使用**: 为收据添加相关标签，便于搜索
3. **定期清理**: 定期删除不需要的收据文件
4. **备份重要收据**: 重要收据建议本地备份

### 通知管理建议
1. **合理设置**: 根据工作需求调整通知设置
2. **及时处理**: 定期查看和处理通知
3. **分类管理**: 使用通知类型进行有效分类
4. **权限控制**: 确保只有相关人员收到敏感通知

## 故障排除

### 常见问题

#### 1. 文件上传失败
- 检查文件大小是否超过10MB
- 确认文件格式为图片或PDF
- 验证用户权限是否正确

#### 2. 通知不显示
- 检查Firebase连接状态
- 确认用户已登录
- 验证通知设置是否正确

#### 3. 权限错误
- 确认用户角色设置正确
- 检查Firestore安全规则
- 验证Storage访问权限

### 技术支持
如遇到技术问题，请检查：
1. 浏览器控制台错误信息
2. Firebase控制台日志
3. 网络连接状态
4. 用户权限设置

## 未来扩展

### 计划中的功能
1. **OCR收据识别**: 自动提取收据信息
2. **批量上传**: 支持多个文件同时上传
3. **收据搜索**: 基于标签和描述的搜索功能
4. **邮件通知**: 集成邮件通知系统
5. **移动端优化**: 改进移动端用户体验

### 性能优化
1. **图片压缩**: 自动压缩上传的图片
2. **缓存策略**: 实现智能缓存机制
3. **分页加载**: 大量数据的分页显示
4. **离线支持**: 离线状态下的基本功能

---

*最后更新: 2024年12月* 